<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.11: http://docutils.sourceforge.net/" />
<title>NoesisGUI Integration Tutorial</title>
<link rel="stylesheet" href="style/noesis.css" type="text/css" />
</head>
<body>
<div class="document" id="noesisgui-integration-tutorial">
<div>
    <div class="headerbg">
        <center><img src="NoesisLogo.png" class="headerimg"/></center>
    </div>
    <div class="headermenu">
        <a href="Gui.Core.Index.html" class="headerlink">Documentation Index</a>
    </div>
</div>
<h1 class="title">NoesisGUI Integration Tutorial</h1>

<p><img alt="zip" class="align-middle" src="zip.png" /> <a class="reference external" href="Integration.zip">Tutorial Data</a></p>
<p>NoesisGUI comes with its own application framework to develop multi-platform applications (read this <a class="reference external" href="Gui.Core.ApplicationTutorial.html">tutorial</a> for more information). But integrating NoesisGUI in your own application framework is also possible. This tutorial concentrates on the steps you must follow to render xaml interfaces with NoesisGUI inside your own application.</p>
<p>Integration samples for OpenGL, DirectX v9.0, Android and iOS are provided. The code mentioned in this document makes references to that samples.</p>
<ul class="simple">
<li><a class="reference internal" href="#directx">DirectX</a></li>
<li><a class="reference internal" href="#opengl">OpenGL</a></li>
<li><a class="reference internal" href="#ios">iOS</a></li>
<li><a class="reference internal" href="#android">Android</a></li>
</ul>
<div class="section" id="prerequisites">
<h1>Prerequisites</h1>
<p>This tutorial assumes that you already know about the following:</p>
<ul class="simple">
<li>You know how to build .xaml files and generate a cache that can be used at runtime. If not, read the <a class="reference external" href="Resource.BuildTool.BuildTool.html">BuildTool</a> document. For these samples we will be using data from the <em>Gui/Tutorials</em> package. It is mandatory that you build those resources for the desired platforms.</li>
</ul>
<blockquote>
<pre class="literal-block">
&gt; Resource.BuildTool.exe scan Gui/Tutorials --platform DX9
&gt; Resource.BuildTool.exe build Gui/Tutorials --platform DX9

&gt; Resource.BuildTool.exe scan Gui/Tutorials --platform GL
&gt; Resource.BuildTool.exe scan Gui/Tutorials --platform GL
</pre>
</blockquote>
<ul class="simple">
<li>You understand how to extend NoesisGUI with your own classes as described in the <a class="reference external" href="Gui.Core.ExtendingTutorial.html">Extending NoesisGUI</a> tutorial.</li>
</ul>
</div>
<div class="section" id="sdk-directories">
<h1>SDK Directories</h1>
<p>Basically you must pay attention to the following directories that are stored at the root of NoesisGUI SDK location:</p>
<ul class="simple">
<li><strong>Bin/</strong>: This is the directory where dynamic libraries and cached resources can be found. Your executable must be able to reach this path. The easiest way is copying this files to where your executable is located. This is the unique directory you need at runtime.</li>
<li><strong>Include/</strong>: Directory for public headers. You must add this path to your <em>additional include directories</em> in your project</li>
<li><strong>Lib/</strong>: Object libraries to link against are stored in this directory. Like the include directory, you must add this path to you <em>additional libraries directory</em>. Apart from adding this directory you must link with the proper library files</li>
<li><strong>Data/</strong>: All needed resources, like images and xaml files, must be stored inside the Packages directory that is located in the Data directory. Resources are organized in <a class="reference external" href="Resource.BuildTool.DataPackages.html">Data Packages</a> tutorial.</li>
</ul>
</div>
<div class="section" id="using-noesisgui">
<h1>Using NoesisGUI</h1>
<p>An overview is given in this section to understand the steps that are needed to use NoesisGUI. This section applies to all the platforms. For specific details about each platform and fully working samples please read the next sections.</p>
<div class="section" id="initialization">
<h2>Initialization</h2>
<p>Before being able to render any .xaml the following steps must be performed <em>once</em>:</p>
<ol class="arabic simple">
<li>A pre-initialization phase where client code can implement several hooks that modify the default behavior of NoesisGui. Memory allocations, error signaling and file system operations can be redirected to external functions.</li>
<li>Noesis Kernel initialization</li>
</ol>
<blockquote>
<div class="highlight"><pre><span class="c1">// Launch Noesis Kernel</span>
<span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>
</pre></div>
</blockquote>
<ol class="arabic simple" start="3">
<li>Register own classes (optional) as described <a class="reference external" href="Gui.Core.ExtendingTutorial.html">here</a>.</li>
</ol>
<blockquote>
<div class="highlight"><pre><span class="c1">// Register own classes</span>
<span class="n">NsRegisterReflection</span><span class="p">(</span><span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetComponentFactory</span><span class="p">(),</span> <span class="nb">true</span><span class="p">);</span>
</pre></div>
</blockquote>
<ol class="arabic simple" start="4">
<li>Initialize sub-systems</li>
</ol>
<blockquote>
<div class="highlight"><pre><span class="c1">// Start Up Noesis Systems</span>
<span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">InitSystems</span><span class="p">();</span>
</pre></div>
</blockquote>
</div>
<div class="section" id="resource-loading">
<h2>Resource Loading</h2>
<p>XAMLs are loaded using the helper function <strong>LoadXaml</strong> declared in &lt;NsGui/IRenderer.h&gt;.</p>
<div class="highlight"><pre><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">UIElement</span><span class="o">&gt;</span> <span class="n">xaml</span> <span class="o">=</span> <span class="n">LoadXaml</span><span class="o">&lt;</span><span class="n">UIElement</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;Gui/Tutorials/Integration/GL/UI.xaml&quot;</span><span class="p">);</span>
</pre></div>
<p>Once loaded, you need a renderer associated to it. This renderer needs valid dimensions to layout. Each time your window or surface dimensions change you must indicate it to the renderer.</p>
<div class="highlight"><pre><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">IRenderer</span><span class="o">&gt;</span> <span class="n">xamlRenderer</span> <span class="o">=</span> <span class="n">CreateRenderer</span><span class="p">(</span><span class="n">xaml</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
<span class="n">xamlRenderer</span><span class="o">-&gt;</span><span class="n">SetSize</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="attaching-to-events">
<h2>Attaching to events</h2>
<p>You must connect UI events to local functions to allow UI interaction. An easy way is connecting control events with local <a class="reference external" href="Core.Kernel.Delegates.html">delegates</a>. You only have to find the desired controls by name and connect them to the proper delegates.</p>
<div class="highlight"><pre><span class="n">FrameworkElement</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">NsStaticCast</span><span class="o">&lt;</span><span class="n">FrameworkElement</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">xaml</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
<span class="n">Slider</span><span class="o">*</span> <span class="n">slider</span> <span class="o">=</span> <span class="n">NsStaticCast</span><span class="o">&lt;</span><span class="n">Slider</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">FindName</span><span class="p">(</span><span class="s">&quot;Luminance&quot;</span><span class="p">));</span>
<span class="n">slider</span><span class="o">-&gt;</span><span class="n">ValueChanged</span><span class="p">()</span> <span class="o">+=</span> <span class="n">MakeDelegate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LuminanceChanged</span><span class="p">);</span>
</pre></div>
<p>An alternative is using a <a class="reference external" href="Gui.Core.ApplicationTutorial.html#code-behind">Code-Behind</a> class.</p>
</div>
<div class="section" id="input-management">
<h2>Input Management</h2>
<p>There are functions in the renderer interface to pass input events from your application to the UI. Your application must collect the events from the operating system and translate them to IRenderer calls.</p>
<div class="highlight"><pre><span class="n">renderer</span><span class="o">-&gt;</span><span class="n">MouseMove</span><span class="p">(</span><span class="n">mouseX</span><span class="p">,</span> <span class="n">mouseY</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="update-and-render">
<h2>Update and Render</h2>
<p>In the loop of your application your must perform the following steps:</p>
<ol class="arabic simple">
<li><strong>Tick</strong> the kernel to update all the systems.</li>
</ol>
<blockquote>
<div class="highlight"><pre><span class="c1">// Tick kernel</span>
<span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Tick</span><span class="p">();</span>
</pre></div>
</blockquote>
<ol class="arabic simple" start="2">
<li><strong>Update</strong> each renderer with the current time and collect its render commands.</li>
</ol>
<blockquote>
<div class="highlight"><pre><span class="c1">// Update UI</span>
<span class="n">renderer</span><span class="o">-&gt;</span><span class="n">Update</span><span class="p">(</span><span class="n">fTimeInSeconds</span><span class="p">);</span>
<span class="n">RenderCommands</span> <span class="n">commands</span> <span class="o">=</span> <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">WaitForUpdate</span><span class="p">();</span>
</pre></div>
<p><strong>NOTE:</strong> Update() is asynchronous. To improve cpu usage you could perform additional work between Update() and WaitForUpdate(). Even WaitForUpdate() could be executed from another thread.</p>
</blockquote>
<ol class="arabic simple" start="3">
<li><strong>Render</strong>. The returned render commands from WaitForUpdate() are executed by calling the Render() function that send the data to the GPU. This is the unique function that invoke GPU commands. There are two kind of blocks inside RenderCommands:</li>
</ol>
<blockquote>
<ul class="simple">
<li>Offscreen render commands: these commands update textures that are needed by the main render. For optimal performance these commands must be execute <strong>before</strong> setting and clearing the final surface. This is critical for Tiled architectures.</li>
<li>Main render commands: these are the commands that directly render in the active surface. These commands must be called while you are rendering in your surface. For example, after you render the scene 3D.</li>
</ul>
<p>Note that because the Render() function modifies the GPU state, you must restore it properly to a sane state for your application.</p>
<div class="highlight"><pre><span class="c1">// Render offscreen</span>
<span class="n">xamlRenderer</span><span class="o">-&gt;</span><span class="n">Render</span><span class="p">(</span><span class="n">commands</span><span class="p">.</span><span class="n">offscreenCommands</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>

<span class="c1">// Start frame</span>
<span class="n">glBindFramebuffer</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">glClear</span><span class="p">(</span><span class="n">GL_COLOR_BUFFER_BIT</span> <span class="o">|</span> <span class="n">GL_DEPTH_BUFFER_BIT</span><span class="p">);</span>

<span class="c1">// Render Scene</span>
<span class="c1">// ...</span>

<span class="c1">// Render HUD</span>
<span class="n">xamlRenderer</span><span class="o">-&gt;</span><span class="n">Render</span><span class="p">(</span><span class="n">commands</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>

<span class="c1">// SwapBuffers</span>
<span class="c1">// ...</span>
</pre></div>
</blockquote>
</div>
<div class="section" id="finalization">
<h2>Finalization</h2>
<p>Before exiting from your application the kernel must be properly closed invoking the <strong>Shutdown()</strong> function. This will close all systems and free all resources. Remember to free all pointers before that invocation (for example, if you have global objects).</p>
<div class="highlight"><pre><span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Shutdown</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="directx">
<h1>DirectX</h1>
<p>Both Visual Studio 2005 and Visual Studio 2008 compilers are supported. We are going to describe how to configure a Visual Studio 2005 project. Similar steps must be performed on Visual Studio 2008.</p>
<ol class="arabic simple">
<li>Add path to <strong>Additional Include Directories</strong></li>
<li>Add path to <strong>Additional Library Directories</strong></li>
<li>Add the following libraries to additional Dependencies in <strong>Linker Input</strong>: <em>Noesis.lib</em></li>
<li>The executable of the project must be located in the NoesisSDK/Bin directory where noesis dynamic libraries are located. Adjust this setting in the <strong>General/Output</strong> Directory setting.</li>
</ol>
<p>Although NoesisSDK compiles 100% without warnings, there are some of them that are disabled when building our binaries that could appear in your project. To disable them we recommend that you include pragma directives before including our headers.</p>
<div class="highlight"><pre><span class="cp">#pragma warning(disable: 4275)</span>
<span class="cp">#pragma warning(disable: 4251)</span>
<span class="cp">#pragma warning(disable: 4311)</span>

<span class="cp">#include &lt;Noesis.h&gt;</span>
<span class="p">...</span>
</pre></div>
<p>Apart from that, you may need NOMINMAX to be defined in your project to avoid conflicts between windows headers and the c++ standard headers.</p>
<p>The sample from DirectX v9.0 is a modified version of the ShadowVolume scene include in the DirectX SDK. For brevity only relevant parts are included here.</p>
<div class="section" id="id1">
<h2>Initialization</h2>
<div class="highlight"><pre><span class="c1">// Install an error handler to catch any problem with NoesisGui</span>
<span class="n">Noesis</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">SetErrorHandler</span><span class="p">(</span><span class="n">ErrorHandler</span><span class="p">);</span>

<span class="c1">// Launch Noesis Kernel</span>
<span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>

<span class="c1">// Start Up Noesis Systems</span>
<span class="n">IDX9RenderSystem</span><span class="o">::</span><span class="n">SetDevice</span><span class="p">(</span><span class="n">DXUTGetD3D9Device</span><span class="p">());</span>
<span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">InitSystems</span><span class="p">();</span>

<span class="c1">// Create the UI renderer</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">UIElement</span><span class="o">&gt;</span> <span class="n">xaml</span> <span class="o">=</span> <span class="n">LoadXaml</span><span class="o">&lt;</span><span class="n">UIElement</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;Gui/Tutorials/Integration/DX9/UI.xaml&quot;</span><span class="p">);</span>
<span class="n">gXamlRenderer</span> <span class="o">=</span> <span class="n">CreateRenderer</span><span class="p">(</span><span class="n">xaml</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
<span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">SetSize</span><span class="p">(</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">);</span>
<span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">SetAntialiasingMode</span><span class="p">(</span><span class="n">Noesis</span><span class="o">::</span><span class="n">Gui</span><span class="o">::</span><span class="n">AntialiasingMode_PPAA</span><span class="p">);</span>

<span class="c1">// Attach to events</span>
<span class="n">FrameworkElement</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">NsStaticCast</span><span class="o">&lt;</span><span class="n">FrameworkElement</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">xaml</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>

<span class="n">Slider</span><span class="o">*</span> <span class="n">slider</span> <span class="o">=</span> <span class="n">NsStaticCast</span><span class="o">&lt;</span><span class="n">Slider</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">FindName</span><span class="p">(</span><span class="s">&quot;Luminance&quot;</span><span class="p">));</span>
<span class="n">slider</span><span class="o">-&gt;</span><span class="n">ValueChanged</span><span class="p">()</span> <span class="o">+=</span> <span class="n">MakeDelegate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LuminanceChanged</span><span class="p">);</span>

<span class="n">ComboBox</span><span class="o">*</span> <span class="n">combo0</span> <span class="o">=</span> <span class="n">NsStaticCast</span><span class="o">&lt;</span><span class="n">ComboBox</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">FindName</span><span class="p">(</span><span class="s">&quot;Background&quot;</span><span class="p">));</span>
<span class="n">combo0</span><span class="o">-&gt;</span><span class="n">SelectionChanged</span><span class="p">()</span> <span class="o">+=</span> <span class="n">MakeDelegate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BackgroundChanged</span><span class="p">);</span>

<span class="n">ComboBox</span><span class="o">*</span> <span class="n">combo1</span> <span class="o">=</span> <span class="n">NsStaticCast</span><span class="o">&lt;</span><span class="n">ComboBox</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">FindName</span><span class="p">(</span><span class="s">&quot;Lights&quot;</span><span class="p">));</span>
<span class="n">combo1</span><span class="o">-&gt;</span><span class="n">SelectionChanged</span><span class="p">()</span> <span class="o">+=</span> <span class="n">MakeDelegate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LightsChanged</span><span class="p">);</span>

<span class="n">ComboBox</span><span class="o">*</span> <span class="n">combo2</span> <span class="o">=</span> <span class="n">NsStaticCast</span><span class="o">&lt;</span><span class="n">ComboBox</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">FindName</span><span class="p">(</span><span class="s">&quot;Visualization&quot;</span><span class="p">));</span>
<span class="n">combo2</span><span class="o">-&gt;</span><span class="n">SelectionChanged</span><span class="p">()</span> <span class="o">+=</span> <span class="n">MakeDelegate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">VisualizationChanged</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="message-handling">
<h2>Message Handling</h2>
<p>Mouse Capture can be easily implemented using VisualTreeHelper::HitTest as shown in the example code.</p>
<div class="highlight"><pre><span class="k">static</span> <span class="kt">bool</span> <span class="n">captured</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="k">switch</span> <span class="p">(</span><span class="n">uMsg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">case</span> <span class="n">WM_MOUSEMOVE</span>:
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gXamlRenderer</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">MouseMove</span><span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">),</span> <span class="n">HIWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">WM_LBUTTONDOWN</span>:
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gXamlRenderer</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">MouseButtonDown</span><span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">),</span> <span class="n">HIWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">),</span> <span class="n">MouseButton_Left</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">VisualTreeHelper</span><span class="o">::</span><span class="n">HitTest</span><span class="p">(</span><span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">GetContent</span><span class="p">(),</span> <span class="n">Point</span><span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">),</span> <span class="n">HIWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">))).</span><span class="n">visualHit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">captured</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">WM_LBUTTONUP</span>:
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gXamlRenderer</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">MouseButtonUp</span><span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">),</span> <span class="n">HIWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">),</span> <span class="n">MouseButton_Left</span><span class="p">);</span>
            <span class="n">captured</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">captured</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">g_Camera</span><span class="p">.</span><span class="n">HandleMessages</span><span class="p">(</span> <span class="n">hWnd</span><span class="p">,</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span> <span class="p">);</span>
    <span class="n">g_MCamera</span><span class="p">.</span><span class="n">HandleMessages</span><span class="p">(</span> <span class="n">hWnd</span><span class="p">,</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span> <span class="p">);</span>
    <span class="n">g_LCamera</span><span class="p">.</span><span class="n">HandleMessages</span><span class="p">(</span> <span class="n">hWnd</span><span class="p">,</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="lost-device">
<h2>Lost-Device</h2>
<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">IsInitialized</span><span class="p">())</span>
<span class="p">{</span>
    <span class="c1">//gXamlRenderer-&gt;SetSurface(0);</span>
    <span class="n">NsGetSystem</span><span class="o">&lt;</span><span class="n">IDX9RenderSystem</span><span class="o">&gt;</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">OnLostDevice</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">SAFE_RELEASE</span><span class="p">(</span><span class="n">gStateBlock</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="reset-device">
<h2>Reset-Device</h2>
<div class="highlight"><pre><span class="n">pd3dDevice</span><span class="o">-&gt;</span><span class="n">CreateStateBlock</span><span class="p">(</span><span class="n">D3DSBT_ALL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gStateBlock</span><span class="p">);</span>

 <span class="k">if</span> <span class="p">(</span><span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">IsInitialized</span><span class="p">())</span>
 <span class="p">{</span>
     <span class="n">NsGetSystem</span><span class="o">&lt;</span><span class="n">IDX9RenderSystem</span><span class="o">&gt;</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">OnResetDevice</span><span class="p">();</span>
     <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">SetSize</span><span class="p">(</span><span class="n">pBackBufferSurfaceDesc</span><span class="o">-&gt;</span><span class="n">Width</span><span class="p">,</span> <span class="n">pBackBufferSurfaceDesc</span><span class="o">-&gt;</span><span class="n">Height</span><span class="p">);</span>
 <span class="p">}</span>
</pre></div>
</div>
<div class="section" id="frame">
<h2>Frame</h2>
<p>Note that, in DirectX9, we are using a StateBlock object to save and restore the GPU state.</p>
<div class="highlight"><pre><span class="c1">// Render the scene</span>
<span class="k">if</span><span class="p">(</span> <span class="n">SUCCEEDED</span><span class="p">(</span> <span class="n">pd3dDevice</span><span class="o">-&gt;</span><span class="n">BeginScene</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Tick kernel</span>
    <span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Tick</span><span class="p">();</span>

    <span class="c1">// Update UI</span>
    <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">Update</span><span class="p">(</span><span class="n">fTime</span><span class="p">);</span>
    <span class="n">RenderCommands</span> <span class="n">commands</span> <span class="o">=</span> <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">WaitForUpdate</span><span class="p">();</span>

    <span class="n">IDirect3DSurface9</span><span class="o">*</span> <span class="n">color</span><span class="p">;</span>
    <span class="n">DXUTGetD3D9Device</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetRenderTarget</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">color</span><span class="p">);</span>
    <span class="n">color</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>

    <span class="n">IDirect3DSurface9</span><span class="o">*</span> <span class="n">depth</span><span class="p">;</span>
    <span class="n">DXUTGetD3D9Device</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetDepthStencilSurface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">depth</span><span class="p">);</span>
    <span class="n">depth</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>

    <span class="c1">// Draw surface</span>
    <span class="n">V</span><span class="p">(</span><span class="n">gStateBlock</span><span class="o">-&gt;</span><span class="n">Capture</span><span class="p">());</span>
    <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">Render</span><span class="p">(</span><span class="n">commands</span><span class="p">.</span><span class="n">offscreenCommands</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
    <span class="n">V</span><span class="p">(</span><span class="n">gStateBlock</span><span class="o">-&gt;</span><span class="n">Apply</span><span class="p">());</span>

    <span class="n">DXUTGetD3D9Device</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetRenderTarget</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
    <span class="n">DXUTGetD3D9Device</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetDepthStencilSurface</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>

    <span class="c1">// Clear the render target and the zbuffer</span>
    <span class="n">V</span><span class="p">(</span> <span class="n">pd3dDevice</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">D3DCLEAR_TARGET</span> <span class="o">|</span> <span class="n">D3DCLEAR_ZBUFFER</span><span class="p">,</span> <span class="n">D3DCOLOR_ARGB</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">121</span> <span class="p">),</span> <span class="mf">1.0f</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>

    <span class="p">...</span>
    <span class="c1">///////////////////////</span>
    <span class="c1">// RENDER SCENE</span>
    <span class="c1">///////////////////////</span>
    <span class="p">...</span>


    <span class="c1">// Draw GUI</span>
    <span class="n">V</span><span class="p">(</span><span class="n">gStateBlock</span><span class="o">-&gt;</span><span class="n">Capture</span><span class="p">());</span>
    <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">Render</span><span class="p">(</span><span class="n">commands</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
    <span class="n">V</span><span class="p">(</span><span class="n">gStateBlock</span><span class="o">-&gt;</span><span class="n">Apply</span><span class="p">());</span>


    <span class="n">V</span><span class="p">(</span> <span class="n">pd3dDevice</span><span class="o">-&gt;</span><span class="n">EndScene</span><span class="p">()</span> <span class="p">);</span>
</pre></div>
</div>
<div class="section" id="shutdown">
<h2>Shutdown</h2>
<div class="highlight"><pre><span class="c1">// Free global resources and shutdown kernel</span>
<span class="n">gXamlRenderer</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Shutdown</span><span class="p">();</span>
</pre></div>
<img alt="SDKGuideImg1.jpg" src="SDKGuideImg1.jpg" />
</div>
</div>
<div class="section" id="opengl">
<h1>OpenGL</h1>
<p>The desktop GL sample includes projects for both Visual Studio and Xcode.</p>
<p>By default, in Windows, the renderer chosen is DirectX9. In case an OpenGL renderer is desired it must be indicated. In platforms where there is only a single renderer this step is not needed.</p>
<div class="highlight"><pre><span class="n">NsConfigValue</span><span class="p">(</span><span class="s">&quot;Render.RenderSystem&quot;</span><span class="p">,</span> <span class="s">&quot;Render&quot;</span><span class="p">,</span> <span class="s">&quot;GL&quot;</span><span class="p">);</span>
</pre></div>
<p>Apart from that the code, that uses GLUT, is quite straightforward and easy to understand.</p>
<div class="highlight"><pre><span class="cm">/* ============================================================================</span>
<span class="cm">** The original version of this sample was taken from:</span>
<span class="cm">**  http://www.lousodrome.net/opengl/</span>
<span class="cm">** ========================================================================= */</span>

<span class="cp">#define NOESIS_GUI</span>

<span class="cp">#include &lt;stdlib.h&gt;</span>

<span class="cp">#ifdef _MSC_VER</span>
    <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">windows</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
    <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">GL</span><span class="o">/</span><span class="n">gl</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
    <span class="err">#</span><span class="n">include</span> <span class="s">&quot;glut.h&quot;</span>
<span class="cp">#else</span>
    <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">GLUT</span><span class="o">/</span><span class="n">glut</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef NOESIS_GUI</span>

<span class="cp">#ifdef _MSC_VER</span>
    <span class="err">#</span><span class="n">pragma</span> <span class="n">warning</span><span class="p">(</span><span class="n">disable</span><span class="o">:</span> <span class="mi">4275</span><span class="p">)</span>
    <span class="err">#</span><span class="n">pragma</span> <span class="n">warning</span><span class="p">(</span><span class="n">disable</span><span class="o">:</span> <span class="mi">4251</span><span class="p">)</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;Noesis.h&gt;</span>
<span class="cp">#include &lt;NsCore/Kernel.h&gt;</span>
<span class="cp">#include &lt;NsCore/NsSystem.h&gt;</span>
<span class="cp">#include &lt;NsCore/NsConfig.h&gt;</span>
<span class="cp">#include &lt;NsGui/UIElement.h&gt;</span>
<span class="cp">#include &lt;NsGui/IRenderer.h&gt;</span>
<span class="cp">#include &lt;NsRender/IRenderSystem.h&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">Noesis</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Noesis</span><span class="o">::</span><span class="n">Core</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Noesis</span><span class="o">::</span><span class="n">Gui</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Noesis</span><span class="o">::</span><span class="n">Render</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Noesis</span><span class="o">::</span><span class="n">Drawing</span><span class="p">;</span>


<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">IRenderer</span><span class="o">&gt;</span> <span class="n">gXamlRenderer</span><span class="p">;</span>

<span class="cp">#ifdef _MSC_VER</span>
    <span class="err">#</span><span class="n">define</span> <span class="n">GL_FRAMEBUFFER</span> <span class="mh">0x8D40</span>

    <span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="n">PFNGLBINDFRAMEBUFFERPROC</span><span class="p">)(</span><span class="n">GLenum</span> <span class="n">target</span><span class="p">,</span> <span class="n">GLuint</span> <span class="n">framebuffer</span><span class="p">);</span>
    <span class="n">PFNGLBINDFRAMEBUFFERPROC</span> <span class="n">glBindFramebuffer</span><span class="p">;</span>

    <span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">PFNGLUSEPROGRAMPROC</span><span class="p">)(</span><span class="n">GLuint</span> <span class="n">program</span><span class="p">);</span>
    <span class="n">PFNGLUSEPROGRAMPROC</span> <span class="n">glUseProgram</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">** Function called to update rendering</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">DisplayFunc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="c1">// Tick kernel</span>
    <span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Tick</span><span class="p">();</span>

    <span class="c1">// Update renderer</span>
    <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">Update</span><span class="p">(</span><span class="n">glutGet</span><span class="p">(</span><span class="n">GLUT_ELAPSED_TIME</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0f</span><span class="p">);</span>
    <span class="c1">// ...Do something useful here because Update() is concurrent...</span>
    <span class="n">RenderCommands</span> <span class="n">commands</span> <span class="o">=</span> <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">WaitForUpdate</span><span class="p">();</span>

    <span class="c1">// Render offscreen</span>
    <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">Render</span><span class="p">(</span><span class="n">commands</span><span class="p">.</span><span class="n">offscreenCommands</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
<span class="cp">#endif</span>

    <span class="k">static</span> <span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">glClearColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">glDepthMask</span><span class="p">(</span><span class="n">GL_TRUE</span><span class="p">);</span>
    <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_BLEND</span><span class="p">);</span>
    <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_SCISSOR_TEST</span><span class="p">);</span>
    <span class="n">glDepthFunc</span><span class="p">(</span><span class="n">GL_LESS</span><span class="p">);</span>
    <span class="n">glClearDepth</span><span class="p">(</span><span class="mf">1.0f</span><span class="p">);</span>
    <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_DEPTH_TEST</span><span class="p">);</span>
    <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_CULL_FACE</span><span class="p">);</span>
    <span class="n">glUseProgram</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">glBindFramebuffer</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="cm">/* Clear the buffer, clear the matrix */</span>
    <span class="n">glClear</span><span class="p">(</span><span class="n">GL_COLOR_BUFFER_BIT</span> <span class="o">|</span> <span class="n">GL_DEPTH_BUFFER_BIT</span><span class="p">);</span>
    <span class="n">glLoadIdentity</span><span class="p">();</span>

    <span class="cm">/* A step backward, then spin the cube */</span>
    <span class="n">glTranslatef</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">glRotatef</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">glRotatef</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="cm">/* We tell we want to draw quads */</span>
    <span class="n">glBegin</span><span class="p">(</span><span class="n">GL_QUADS</span><span class="p">);</span>

    <span class="cm">/* Every four calls to glVertex, a quad is drawn */</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>
    <span class="n">glColor3f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">glVertex3f</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">);</span>

    <span class="cm">/* No more quads */</span>
    <span class="n">glEnd</span><span class="p">();</span>

    <span class="cm">/* Rotate a bit more */</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">;</span>

<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="c1">// Render GUI</span>
    <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">Render</span><span class="p">(</span><span class="n">commands</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
<span class="cp">#endif</span>

    <span class="cm">/* End */</span>
    <span class="n">glFlush</span><span class="p">();</span>
    <span class="n">glutSwapBuffers</span><span class="p">();</span>

    <span class="cm">/* Update again and again */</span>
    <span class="n">glutPostRedisplay</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">** Function called when the window is created or resized</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">ReshapeFunc</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL_PROJECTION</span><span class="p">);</span>

    <span class="n">glLoadIdentity</span><span class="p">();</span>
    <span class="n">gluPerspective</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="n">height</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
    <span class="n">glViewport</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

    <span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL_MODELVIEW</span><span class="p">);</span>
    <span class="n">glutPostRedisplay</span><span class="p">();</span>

<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">SetSize</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">MouseFunc</span><span class="p">(</span><span class="kt">int</span> <span class="n">button</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">button</span> <span class="o">==</span> <span class="n">GLUT_LEFT_BUTTON</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">GLUT_UP</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">MouseButtonUp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">MouseButton_Left</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">MouseButtonDown</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">MouseButton_Left</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">MouseMove</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">MouseMove</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef NOESIS_GUI</span>
<span class="kt">void</span> <span class="nf">ErrorHandler</span><span class="p">(</span><span class="k">const</span> <span class="n">NsChar</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span> <span class="n">NsInt</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="n">NsChar</span><span class="o">*</span> <span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">ERROR: %s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Free global resources and shutdown kernel</span>
    <span class="n">gXamlRenderer</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
    <span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Shutdown</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Creation of the window */</span>
    <span class="n">glutInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="n">glutInitDisplayMode</span><span class="p">(</span><span class="n">GLUT_RGB</span> <span class="o">|</span> <span class="n">GLUT_DOUBLE</span> <span class="o">|</span> <span class="n">GLUT_DEPTH</span> <span class="o">|</span> <span class="n">GLUT_STENCIL</span><span class="p">);</span>
    <span class="n">glutInitWindowSize</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
    <span class="n">glutCreateWindow</span><span class="p">(</span><span class="s">&quot;Spinning cube&quot;</span><span class="p">);</span>

<span class="cp">#ifdef _MSC_VER</span>
    <span class="n">glBindFramebuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PFNGLBINDFRAMEBUFFERPROC</span><span class="p">)</span><span class="n">wglGetProcAddress</span><span class="p">(</span><span class="s">&quot;glBindFramebuffer&quot;</span><span class="p">);</span>
    <span class="n">glUseProgram</span> <span class="o">=</span> <span class="p">(</span><span class="n">PFNGLUSEPROGRAMPROC</span><span class="p">)</span><span class="n">wglGetProcAddress</span><span class="p">(</span><span class="s">&quot;glUseProgram&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="p">{</span>
        <span class="c1">// Install an error handler to catch any problem with NoesisGui</span>
        <span class="n">Noesis</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">SetErrorHandler</span><span class="p">(</span><span class="n">ErrorHandler</span><span class="p">);</span>

        <span class="c1">// Force the OpenGL renderer</span>
        <span class="n">NsConfigValue</span><span class="p">(</span><span class="s">&quot;Render.RenderSystem&quot;</span><span class="p">,</span> <span class="s">&quot;Render&quot;</span><span class="p">,</span> <span class="s">&quot;GL&quot;</span><span class="p">);</span>

        <span class="c1">// Launch Noesis Kernel</span>
        <span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>

        <span class="c1">// Create a OpenGL context that will be used by NoesisGui.</span>
        <span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">InitSystems</span><span class="p">();</span>

        <span class="c1">// Create the UI renderer</span>
        <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">UIElement</span><span class="o">&gt;</span> <span class="n">xaml</span> <span class="o">=</span> <span class="n">LoadXaml</span><span class="o">&lt;</span><span class="n">UIElement</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;Gui/Tutorials/Integration/GL/UI.xaml&quot;</span><span class="p">);</span>
        <span class="c1">//Ptr&lt;UIElement&gt; xaml = LoadXaml&lt;UIElement&gt;(&quot;Gui/Samples/tux.xaml&quot;);</span>
        <span class="c1">//Ptr&lt;UIElement&gt; xaml = LoadXaml&lt;UIElement&gt;(&quot;Gui/Samples/Button.xaml&quot;);</span>
        <span class="c1">//Ptr&lt;UIElement&gt; xaml = LoadXaml&lt;UIElement&gt;(&quot;Gui/Samples/Time.xaml&quot;);</span>
        <span class="c1">//Ptr&lt;UIElement&gt; xaml = LoadXaml&lt;UIElement&gt;(&quot;Gui/Samples/CarHUD.xaml&quot;);</span>
        <span class="c1">//Ptr&lt;UIElement&gt; xaml = LoadXaml&lt;UIElement&gt;(&quot;Gui/Samples/Text.xaml&quot;);</span>
        <span class="n">gXamlRenderer</span> <span class="o">=</span> <span class="n">CreateRenderer</span><span class="p">(</span><span class="n">xaml</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
        <span class="n">gXamlRenderer</span><span class="o">-&gt;</span><span class="n">SetAntialiasingMode</span><span class="p">(</span><span class="n">Noesis</span><span class="o">::</span><span class="n">Gui</span><span class="o">::</span><span class="n">AntialiasingMode_PPAA</span><span class="p">);</span>

        <span class="n">atexit</span><span class="p">(</span><span class="n">Shutdown</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="cm">/* Declaration of the callbacks */</span>
    <span class="n">glutDisplayFunc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DisplayFunc</span><span class="p">);</span>
    <span class="n">glutReshapeFunc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ReshapeFunc</span><span class="p">);</span>
    <span class="n">glutMouseFunc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MouseFunc</span><span class="p">);</span>
    <span class="n">glutMotionFunc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MouseMove</span><span class="p">);</span>
    <span class="n">glutPassiveMotionFunc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MouseMove</span><span class="p">);</span>

    <span class="cm">/* Loop */</span>
    <span class="n">glutMainLoop</span><span class="p">();</span>

    <span class="cm">/* Never reached */</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ========================================================================= */</span>
</pre></div>
<img alt="SDKGuideImg2.jpg" src="SDKGuideImg2.jpg" />
</div>
<div class="section" id="ios">
<h1>iOS</h1>
<p>The provided sample for iOS is configured using XCode 4.6. Include and Library directories and configured in the <strong>Search Paths</strong> section of the project settings. As dynamic libraries are not allowed in iOS we need to statically link against the library found in the <em>/Lib</em> folder. We used the following extra settings:</p>
<div class="highlight"><pre><span class="n">ARCHS</span> <span class="o">=</span> <span class="n">armv7</span><span class="p">;</span>
<span class="n">CLANG_CXX_LIBRARY</span> <span class="o">=</span> <span class="s">&quot;libstdc++&quot;</span><span class="p">;</span>
<span class="n">GCC_SYMBOLS_PRIVATE_EXTERN</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
<span class="n">HEADER_SEARCH_PATHS</span> <span class="o">=</span> <span class="s">&quot;NoesisGUI-iOS/Include&quot;</span><span class="p">;</span>
<span class="n">LIBRARY_SEARCH_PATHS</span> <span class="o">=</span> <span class="s">&quot;NoesisGUI-iOS/Lib&quot;</span><span class="p">;</span>
<span class="n">OTHER_LDFLAGS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&quot;-lnoesis&quot;</span><span class="p">,</span>
<span class="p">);</span>
</pre></div>
<p>Apart from that, the following <strong>Frameworks</strong> are needed:</p>
<ul class="simple">
<li>UIKit.framework</li>
<li>Foundation.framework</li>
<li>CoreGraphics.framework</li>
<li>GLKit.framework</li>
<li>OpenGLES.framework</li>
</ul>
<p><strong>NOTE:</strong> the iOS project is configured for automatic data deployment of the NoesisGUI data cache.</p>
<div class="section" id="id2">
<h2>Initialization</h2>
<div class="highlight"><pre><span class="n">Noesis</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">SetErrorHandler</span><span class="p">(</span><span class="n">ErrorHandler</span><span class="p">);</span>
<span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>
<span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">InitSystems</span><span class="p">();</span>

<span class="c1">// Create the UI renderer</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">UIElement</span><span class="o">&gt;</span> <span class="n">xaml</span> <span class="o">=</span> <span class="n">LoadXaml</span><span class="o">&lt;</span><span class="n">UIElement</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;Gui/Samples/time.xaml&quot;</span><span class="p">);</span>
<span class="n">_xamlRenderer</span> <span class="o">=</span> <span class="n">CreateRenderer</span><span class="p">(</span><span class="n">xaml</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
</pre></div>
</div>
<div class="section" id="render">
<h2>Render</h2>
<div class="highlight"><pre><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">glkView</span><span class="o">:</span><span class="p">(</span><span class="n">GLKView</span> <span class="o">*</span><span class="p">)</span><span class="n">view</span> <span class="n">drawInRect</span><span class="o">:</span><span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="n">rect</span>
<span class="p">{</span>
    <span class="c1">// Tick kernel</span>
    <span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Tick</span><span class="p">();</span>

    <span class="k">static</span> <span class="n">NsFloat64</span> <span class="n">t</span><span class="p">;</span>
    <span class="n">t</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">timeSinceLastUpdate</span><span class="p">;</span>

    <span class="c1">// Update renderer</span>
    <span class="n">_xamlRenderer</span><span class="o">-&gt;</span><span class="n">SetSize</span><span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="n">drawableWidth</span><span class="p">,</span> <span class="n">view</span><span class="p">.</span><span class="n">drawableHeight</span><span class="p">);</span>
    <span class="n">_xamlRenderer</span><span class="o">-&gt;</span><span class="n">Update</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
    <span class="n">RenderCommands</span> <span class="n">commands</span> <span class="o">=</span> <span class="n">_xamlRenderer</span><span class="o">-&gt;</span><span class="n">WaitForUpdate</span><span class="p">();</span>

    <span class="c1">// Render offscreen surfaces</span>
    <span class="n">_xamlRenderer</span><span class="o">-&gt;</span><span class="n">Render</span><span class="p">(</span><span class="n">commands</span><span class="p">.</span><span class="n">offscreenCommands</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>

    <span class="c1">// Restore the state</span>
    <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_BLEND</span><span class="p">);</span>
    <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_DEPTH_TEST</span><span class="p">);</span>
    <span class="n">glDepthFunc</span><span class="p">(</span><span class="n">GL_LESS</span><span class="p">);</span>
    <span class="n">glDepthMask</span><span class="p">(</span><span class="n">GL_TRUE</span><span class="p">);</span>
    <span class="n">glClearDepthf</span><span class="p">(</span><span class="mf">1.0f</span><span class="p">);</span>
    <span class="n">glClearColor</span><span class="p">(</span><span class="mf">0.40f</span><span class="p">,</span> <span class="mf">0.40f</span><span class="p">,</span> <span class="mf">0.40f</span><span class="p">,</span> <span class="mf">1.0f</span><span class="p">);</span>

    <span class="c1">// Frame</span>
    <span class="p">[</span><span class="n">view</span> <span class="n">bindDrawable</span><span class="p">];</span>
    <span class="n">glClear</span><span class="p">(</span><span class="n">GL_COLOR_BUFFER_BIT</span> <span class="o">|</span> <span class="n">GL_DEPTH_BUFFER_BIT</span><span class="p">);</span>

    <span class="n">glBindVertexArrayOES</span><span class="p">(</span><span class="n">_vertexArray</span><span class="p">);</span>

    <span class="c1">// Render the object with GLKit</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">effect</span> <span class="n">prepareToDraw</span><span class="p">];</span>

    <span class="n">glDrawArrays</span><span class="p">(</span><span class="n">GL_TRIANGLES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">36</span><span class="p">);</span>

    <span class="c1">// Render the object again with ES2</span>
    <span class="n">glUseProgram</span><span class="p">(</span><span class="n">_program</span><span class="p">);</span>

    <span class="n">glUniformMatrix4fv</span><span class="p">(</span><span class="n">uniforms</span><span class="p">[</span><span class="n">UNIFORM_MODELVIEWPROJECTION_MATRIX</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_modelViewProjectionMatrix</span><span class="p">.</span><span class="n">m</span><span class="p">);</span>
    <span class="n">glUniformMatrix3fv</span><span class="p">(</span><span class="n">uniforms</span><span class="p">[</span><span class="n">UNIFORM_NORMAL_MATRIX</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_normalMatrix</span><span class="p">.</span><span class="n">m</span><span class="p">);</span>

    <span class="n">glDrawArrays</span><span class="p">(</span><span class="n">GL_TRIANGLES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">36</span><span class="p">);</span>

    <span class="c1">// Render HUD</span>
    <span class="n">_xamlRenderer</span><span class="o">-&gt;</span><span class="n">Render</span><span class="p">(</span><span class="n">commands</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
<img alt="SDKGuideImg3.jpg" src="SDKGuideImg3.jpg" />
</div>
</div>
<div class="section" id="android">
<h1>Android</h1>
<p>The integration sample for Android uses the Native Android API. A Java Activity is needed to preload NoesisGui library.</p>
<div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">hellotriangle</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.app.NativeActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloTriangle</span> <span class="kd">extends</span> <span class="n">NativeActivity</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&quot;Noesis&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>The data cache must be copied inside the /assets folder. It is accesed by the AndroidFileSystem that is created indicating where the data root is located.</p>
<div class="highlight"><pre><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">IFileSystem</span><span class="o">&gt;</span> <span class="n">fileSystem</span> <span class="o">=</span> <span class="n">CreateAndroidFileSystem</span><span class="p">(</span><span class="n">assetManager</span><span class="p">,</span> <span class="s">&quot;NoesisGUI/&quot;</span><span class="p">);</span>
</pre></div>
<p>Apart from those details the sample is a very basic OpenGL ES 2.0 example.</p>
<div class="highlight"><pre><span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">/// Hello Triangle: An OpenGL ES 2.0 Example</span>
<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////////</span>


<span class="cp">#include &lt;stdlib.h&gt;</span>

<span class="cp">#include &lt;android_native_app_glue.h&gt;</span>
<span class="cp">#include &lt;android/native_window.h&gt;</span>
<span class="cp">#include &lt;android/log.h&gt;</span>

<span class="cp">#include &lt;EGL/egl.h&gt;</span>
<span class="cp">#include &lt;GLES2/gl2.h&gt;</span>


<span class="cp">#define LOGI(...) ((void)__android_log_print(ANDROID_LOG_INFO, &quot;HelloTriangle&quot;, __VA_ARGS__))</span>
<span class="cp">#define LOGE(...) ((void)__android_log_print(ANDROID_LOG_ERROR, &quot;HelloTriangle&quot;, __VA_ARGS__))</span>


<span class="cp">#define NOESIS_GUI</span>

<span class="cp">#ifdef NOESIS_GUI</span>

<span class="cp">#pragma warning(disable: 4275)</span>
<span class="cp">#pragma warning(disable: 4251)</span>

<span class="cp">#include &lt;Noesis.h&gt;</span>
<span class="cp">#include &lt;NsCore/Kernel.h&gt;</span>
<span class="cp">#include &lt;NsCore/NsConfig.h&gt;</span>
<span class="cp">#include &lt;NsCore/NsSystem.h&gt;</span>
<span class="cp">#include &lt;NsCore/HighResTimer.h&gt;</span>
<span class="cp">#include &lt;NsFile/AndroidFileSystem.h&gt;</span>
<span class="cp">#include &lt;NsGui/IRenderer.h&gt;</span>
<span class="cp">#include &lt;NsGui/UIElement.h&gt;</span>
<span class="cp">#include &lt;NsResource/IResourceSystem.h&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">Noesis</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Noesis</span><span class="o">::</span><span class="n">Core</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Noesis</span><span class="o">::</span><span class="n">File</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Noesis</span><span class="o">::</span><span class="n">Gui</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Noesis</span><span class="o">::</span><span class="n">Resource</span><span class="p">;</span>

<span class="cp">#endif</span>


<span class="k">struct</span> <span class="n">UserData</span>
<span class="p">{</span>
    <span class="n">android_app</span><span class="o">*</span> <span class="n">app</span><span class="p">;</span>

    <span class="kt">bool</span> <span class="n">animating</span><span class="p">;</span>

    <span class="n">EGLDisplay</span> <span class="n">display</span><span class="p">;</span>
    <span class="n">EGLSurface</span> <span class="n">surface</span><span class="p">;</span>
    <span class="n">EGLContext</span> <span class="n">context</span><span class="p">;</span>
    <span class="n">EGLConfig</span> <span class="n">pixelFormat</span><span class="p">;</span>

    <span class="n">GLuint</span> <span class="n">fbo</span><span class="p">;</span>

    <span class="n">GLuint</span> <span class="n">vShader</span><span class="p">;</span>
    <span class="n">GLuint</span> <span class="n">fShader</span><span class="p">;</span>
    <span class="n">GLuint</span> <span class="n">programObject</span><span class="p">;</span>

    <span class="n">GLint</span> <span class="n">width</span><span class="p">;</span>
    <span class="n">GLint</span> <span class="n">height</span><span class="p">;</span>

<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">IRenderer</span><span class="o">&gt;</span> <span class="n">guiRenderer</span><span class="p">;</span>
    <span class="n">RenderCommands</span> <span class="n">guiCommands</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#ifdef NOESIS_GUI</span>
<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">NoesisErrorHandler</span><span class="p">(</span><span class="k">const</span> <span class="n">NsChar</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span> <span class="n">NsInt</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="n">NsChar</span><span class="o">*</span> <span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Error: %s [%d] : %s&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">NoesisInit</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Noesis</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">SetErrorHandler</span><span class="p">(</span><span class="n">NoesisErrorHandler</span><span class="p">);</span>

    <span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>

    <span class="n">AAssetManager</span><span class="o">*</span> <span class="n">assetManager</span> <span class="o">=</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">activity</span><span class="o">-&gt;</span><span class="n">assetManager</span><span class="p">;</span>
    <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">IFileSystem</span><span class="o">&gt;</span> <span class="n">fileSystem</span> <span class="o">=</span> <span class="n">CreateAndroidFileSystem</span><span class="p">(</span><span class="n">assetManager</span><span class="p">,</span> <span class="s">&quot;NoesisGUI/&quot;</span><span class="p">);</span>
    <span class="n">IResourceSystem</span><span class="o">::</span><span class="n">SetFileSystem</span><span class="p">(</span><span class="n">fileSystem</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>

    <span class="n">NsConfigValue</span><span class="p">(</span><span class="s">&quot;Render.RenderSystem&quot;</span><span class="p">,</span> <span class="s">&quot;Render&quot;</span><span class="p">,</span> <span class="s">&quot;GL&quot;</span><span class="p">);</span>

    <span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">InitSystems</span><span class="p">();</span>

    <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">UIElement</span><span class="o">&gt;</span> <span class="n">content</span> <span class="o">=</span> <span class="n">LoadXaml</span><span class="o">&lt;</span><span class="n">UIElement</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;Gui/Samples/SDKTutorial/UIgl.xaml&quot;</span><span class="p">);</span>
    <span class="c1">//Ptr&lt;UIElement&gt; content = LoadXaml&lt;UIElement&gt;(&quot;Gui/Samples/Tux.xaml&quot;);</span>
    <span class="c1">//Ptr&lt;UIElement&gt; content = LoadXaml&lt;UIElement&gt;(&quot;Gui/Samples/Button.xaml&quot;);</span>
    <span class="c1">//Ptr&lt;UIElement&gt; content = LoadXaml&lt;UIElement&gt;(&quot;Gui/Samples/Time.xaml&quot;);</span>
    <span class="c1">//Ptr&lt;UIElement&gt; content = LoadXaml&lt;UIElement&gt;(&quot;Gui/Samples/CarHUD.xaml&quot;);</span>
    <span class="c1">//Ptr&lt;UIElement&gt; content = LoadXaml&lt;UIElement&gt;(&quot;Gui/Samples/Text.xaml&quot;);</span>

    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span> <span class="o">=</span> <span class="n">CreateRenderer</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">SetSize</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">SetAntialiasingMode</span><span class="p">(</span><span class="n">Noesis</span><span class="o">::</span><span class="n">Gui</span><span class="o">::</span><span class="n">AntialiasingMode_PPAA</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">NoesisResize</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">SetSize</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">NoesisTick</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Tick kernel</span>
    <span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Tick</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">NoesisPreRender</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Update renderer</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">Update</span><span class="p">(</span><span class="n">HighResTimer</span><span class="o">::</span><span class="n">Seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">HighResTimer</span><span class="o">::</span><span class="n">StartTime</span><span class="p">());</span>
        <span class="c1">// ...Do something useful here because Update() is concurrent...</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiCommands</span> <span class="o">=</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">WaitForUpdate</span><span class="p">();</span>

    <span class="c1">// Render offscreen textures</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">Render</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiCommands</span><span class="p">.</span><span class="n">offscreenCommands</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiCommands</span><span class="p">.</span><span class="n">offscreenCommands</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">NoesisPostRender</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Render GUI to the active surface</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">Render</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiCommands</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">GetPtr</span><span class="p">());</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiCommands</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">NoesisShutdown</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// free renderer resources</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiCommands</span><span class="p">.</span><span class="n">offscreenCommands</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiCommands</span><span class="p">.</span><span class="n">commands</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>

    <span class="c1">// shut down NoesisGUI</span>
    <span class="n">NsGetKernel</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Shutdown</span><span class="p">();</span>

    <span class="n">Noesis</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">SetErrorHandler</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="n">GLuint</span> <span class="nf">LoadShader</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">shaderSrc</span><span class="p">,</span> <span class="n">GLenum</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Create the shader object</span>
    <span class="n">GLuint</span> <span class="n">shader</span> <span class="o">=</span> <span class="n">glCreateShader</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">shader</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Unable to create shader [type=%X]&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Load the shader source</span>
    <span class="n">glShaderSource</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shaderSrc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">// Compile the shader</span>
    <span class="n">glCompileShader</span><span class="p">(</span><span class="n">shader</span><span class="p">);</span>

    <span class="c1">// Check the compile status</span>
    <span class="n">GLint</span> <span class="n">compiled</span><span class="p">;</span>
    <span class="n">glGetShaderiv</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="n">GL_COMPILE_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">compiled</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compiled</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">GLint</span> <span class="n">infoLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">glGetShaderiv</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="n">GL_INFO_LOG_LENGTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">infoLen</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">infoLen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
            <span class="n">glGetShaderInfoLog</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
            <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Error compiling shader: %s&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">glDeleteShader</span><span class="p">(</span><span class="n">shader</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">shader</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">bool</span> <span class="nf">UpdateDisplaySize</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">GLint</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">contentRect</span><span class="p">.</span><span class="n">left</span> <span class="o">-</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">contentRect</span><span class="p">.</span><span class="n">right</span><span class="p">;</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">contentRect</span><span class="p">.</span><span class="n">top</span> <span class="o">-</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">contentRect</span><span class="p">.</span><span class="n">bottom</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">ANativeWindow_getWidth</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">);</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">ANativeWindow_getHeight</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">eglQuerySurface</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">,</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">surface</span><span class="p">,</span> <span class="n">EGL_WIDTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
            <span class="n">eglQuerySurface</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">,</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">surface</span><span class="p">,</span> <span class="n">EGL_HEIGHT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">!=</span> <span class="n">w</span> <span class="o">||</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">!=</span> <span class="n">h</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">userData</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
        <span class="n">userData</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
        <span class="n">LOGI</span><span class="p">(</span><span class="s">&quot;Surface size: %dx%d&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">bool</span> <span class="nf">InitDisplay</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// initialize OpenGL ES and EGL</span>
    <span class="n">EGLSurface</span> <span class="n">surface</span><span class="p">;</span>
    <span class="n">EGLContext</span> <span class="n">context</span><span class="p">;</span>

    <span class="n">EGLDisplay</span> <span class="n">display</span> <span class="o">=</span> <span class="n">eglGetDisplay</span><span class="p">(</span><span class="n">EGL_DEFAULT_DISPLAY</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">eglInitialize</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">EGL_FALSE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Can&#39;t initialize display&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eglBindAPI</span><span class="p">(</span><span class="n">EGL_OPENGL_ES_API</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Can&#39;t bind OpenGL ES API&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Here specify the attributes of the desired configuration.</span>
    <span class="c1">// Below, we select an EGLConfig with at least 8 bits per color</span>
    <span class="c1">// component compatible with on-screen windows</span>
    <span class="k">const</span> <span class="n">EGLint</span> <span class="n">attribs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">EGL_RENDERABLE_TYPE</span><span class="p">,</span> <span class="n">EGL_OPENGL_ES2_BIT</span><span class="p">,</span>
        <span class="n">EGL_SURFACE_TYPE</span><span class="p">,</span> <span class="n">EGL_WINDOW_BIT</span><span class="p">,</span>
        <span class="n">EGL_BLUE_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">EGL_GREEN_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">EGL_RED_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">EGL_ALPHA_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">EGL_DEPTH_SIZE</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>
        <span class="n">EGL_STENCIL_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">EGL_NONE</span>
    <span class="p">};</span>

    <span class="c1">// Here, the application chooses the configuration it desires. In this</span>
    <span class="c1">// sample, we have a very simplified selection process, where we pick</span>
    <span class="c1">// the first EGLConfig that matches our criteria</span>
    <span class="n">EGLint</span> <span class="n">numConfigs</span><span class="p">;</span>
    <span class="n">EGLConfig</span> <span class="n">config</span><span class="p">;</span>
    <span class="n">eglChooseConfig</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">attribs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numConfigs</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">numConfigs</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Unable to eglChooseConfig&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// EGL_NATIVE_VISUAL_ID is an attribute of the EGLConfig that is</span>
    <span class="c1">// guaranteed to be accepted by ANativeWindow_setBuffersGeometry().</span>
    <span class="c1">// As soon as we picked a EGLConfig, we can safely reconfigure the</span>
    <span class="c1">// ANativeWindow buffers to match, using EGL_NATIVE_VISUAL_ID.</span>
    <span class="n">EGLint</span> <span class="n">format</span><span class="p">;</span>
    <span class="n">eglGetConfigAttrib</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">EGL_NATIVE_VISUAL_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">);</span>

    <span class="n">ANativeWindow_setBuffersGeometry</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>

    <span class="n">surface</span> <span class="o">=</span> <span class="n">eglCreateWindowSurface</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">// Specify an OpenGL ES 2.0 context</span>
    <span class="k">const</span> <span class="n">EGLint</span> <span class="n">contextAttribs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">EGL_CONTEXT_CLIENT_VERSION</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">EGL_NONE</span>
    <span class="p">};</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">eglCreateContext</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">contextAttribs</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">eglMakeCurrent</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">==</span> <span class="n">EGL_FALSE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Unable to eglMakeCurrent&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">GLint</span> <span class="n">fbo</span><span class="p">;</span>
    <span class="n">glGetIntegerv</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER_BINDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbo</span><span class="p">);</span>

    <span class="c1">// Create a shader for rendering the triangle</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="n">vShaderStr</span><span class="p">[]</span> <span class="o">=</span>
        <span class="s">&quot;attribute vec4 vPosition; </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="s">&quot;void main() </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="s">&quot;{ </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="s">&quot;  gl_Position = vPosition; </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="s">&quot;} </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="n">fShaderStr</span><span class="p">[]</span> <span class="o">=</span>
        <span class="s">&quot;precision mediump float; </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="s">&quot;void main() </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="s">&quot;{ </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="s">&quot;  gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="s">&quot;} </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

    <span class="c1">// Load the vertex/fragment shaders</span>
    <span class="n">GLuint</span> <span class="n">vertexShader</span> <span class="o">=</span> <span class="n">LoadShader</span><span class="p">(</span><span class="n">vShaderStr</span><span class="p">,</span> <span class="n">GL_VERTEX_SHADER</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vertexShader</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">GLuint</span> <span class="n">fragmentShader</span> <span class="o">=</span> <span class="n">LoadShader</span><span class="p">(</span><span class="n">fShaderStr</span><span class="p">,</span> <span class="n">GL_FRAGMENT_SHADER</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fragmentShader</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Create the program object</span>
    <span class="n">GLuint</span> <span class="n">programObject</span> <span class="o">=</span> <span class="n">glCreateProgram</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">programObject</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Unable to create shader program object&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">glAttachShader</span><span class="p">(</span><span class="n">programObject</span><span class="p">,</span> <span class="n">vertexShader</span><span class="p">);</span>
    <span class="n">glAttachShader</span><span class="p">(</span><span class="n">programObject</span><span class="p">,</span> <span class="n">fragmentShader</span><span class="p">);</span>

    <span class="c1">// Bind vPosition to attribute 0</span>
    <span class="n">glBindAttribLocation</span><span class="p">(</span><span class="n">programObject</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;vPosition&quot;</span><span class="p">);</span>

    <span class="c1">// Link the program</span>
    <span class="n">glLinkProgram</span><span class="p">(</span><span class="n">programObject</span><span class="p">);</span>

    <span class="c1">// Check the link status</span>
    <span class="n">GLint</span> <span class="n">linked</span><span class="p">;</span>
    <span class="n">glGetProgramiv</span><span class="p">(</span><span class="n">programObject</span><span class="p">,</span> <span class="n">GL_LINK_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linked</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">linked</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">GLint</span> <span class="n">infoLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">glGetProgramiv</span><span class="p">(</span><span class="n">programObject</span><span class="p">,</span> <span class="n">GL_INFO_LOG_LENGTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">infoLen</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">infoLen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
            <span class="n">glGetProgramInfoLog</span><span class="p">(</span><span class="n">programObject</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
            <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Error linking program: %s&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">glDeleteProgram</span><span class="p">(</span><span class="n">programObject</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Store all created objects</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">=</span> <span class="n">display</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">surface</span> <span class="o">=</span> <span class="n">surface</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">pixelFormat</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">fbo</span> <span class="o">=</span> <span class="n">fbo</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">vShader</span> <span class="o">=</span> <span class="n">vertexShader</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">fShader</span> <span class="o">=</span> <span class="n">fragmentShader</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">programObject</span> <span class="o">=</span> <span class="n">programObject</span><span class="p">;</span>

    <span class="n">UpdateDisplaySize</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>

    <span class="c1">// Initialize GL state</span>
    <span class="n">glClearColor</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">1.0f</span><span class="p">);</span>

<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="n">NoesisInit</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">ResizeDisplay</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">==</span> <span class="n">EGL_NO_DISPLAY</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">UpdateDisplaySize</span><span class="p">(</span><span class="n">userData</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// display size changed</span>
<span class="cp">#ifdef NOESIS_GUI</span>
        <span class="n">NoesisResize</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">DrawFrame</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">==</span> <span class="n">EGL_NO_DISPLAY</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="n">NoesisTick</span><span class="p">();</span>

    <span class="n">NoesisPreRender</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="n">glBindFramebuffer</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Set display dimensions</span>
    <span class="n">glViewport</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

    <span class="c1">// Clear the color buffer</span>
    <span class="n">glClear</span><span class="p">(</span><span class="n">GL_COLOR_BUFFER_BIT</span><span class="p">);</span>

    <span class="c1">// Use the program object</span>
    <span class="n">glUseProgram</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">programObject</span><span class="p">);</span>

    <span class="c1">// Load the vertex data</span>
    <span class="n">GLfloat</span> <span class="n">vertices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">0.0f</span><span class="p">,</span><span class="mf">0.5f</span><span class="p">,</span><span class="mf">0.0f</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5f</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5f</span><span class="p">,</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.5f</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5f</span><span class="p">,</span><span class="mf">0.0f</span> <span class="p">};</span>
    <span class="n">glVertexAttribPointer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">GL_FLOAT</span><span class="p">,</span> <span class="n">GL_FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vertices</span><span class="p">);</span>
    <span class="n">glEnableVertexAttribArray</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">glDrawArrays</span><span class="p">(</span><span class="n">GL_TRIANGLES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="n">NoesisPostRender</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="c1">// End</span>
    <span class="n">glFlush</span><span class="p">();</span>
    <span class="n">eglSwapBuffers</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">,</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">surface</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">ShutdownDisplay</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">==</span> <span class="n">EGL_NO_DISPLAY</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="n">NoesisShutdown</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="n">glDeleteProgram</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">vShader</span><span class="p">);</span>
    <span class="n">glDeleteProgram</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">fShader</span><span class="p">);</span>
    <span class="n">glDeleteProgram</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">programObject</span><span class="p">);</span>

    <span class="n">eglMakeCurrent</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">,</span> <span class="n">EGL_NO_SURFACE</span><span class="p">,</span> <span class="n">EGL_NO_SURFACE</span><span class="p">,</span> <span class="n">EGL_NO_CONTEXT</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">!=</span> <span class="n">EGL_NO_CONTEXT</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">eglDestroyContext</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">,</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">surface</span> <span class="o">!=</span> <span class="n">EGL_NO_SURFACE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">eglDestroySurface</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">,</span> <span class="n">userData</span><span class="o">-&gt;</span><span class="n">surface</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">eglTerminate</span><span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">);</span>

    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">animating</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">=</span> <span class="n">EGL_NO_DISPLAY</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">EGL_NO_CONTEXT</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">surface</span> <span class="o">=</span> <span class="n">EGL_NO_SURFACE</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">KeyDown</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keyCode</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="c1">// TODO: translate key code to NoesisGUI key enum</span>
    <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Key_None</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">KeyDown</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">KeyUp</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keyCode</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="c1">// TODO: translate key code to NoesisGUI key enum</span>
    <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Key_None</span><span class="p">;</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">KeyUp</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">MouseDown</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">,</span> <span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="kt">float</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">MouseButtonDown</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">,</span> <span class="n">MouseButton_Left</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">MouseUp</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">,</span> <span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="kt">float</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">MouseButtonUp</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">,</span> <span class="n">MouseButton_Left</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">MouseMove</span><span class="p">(</span><span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span><span class="p">,</span> <span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="kt">float</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef NOESIS_GUI</span>
    <span class="n">userData</span><span class="o">-&gt;</span><span class="n">guiRenderer</span><span class="o">-&gt;</span><span class="n">MouseMove</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">int32_t</span> <span class="nf">HandleInput</span><span class="p">(</span><span class="n">android_app</span><span class="o">*</span> <span class="n">app</span><span class="p">,</span> <span class="n">AInputEvent</span><span class="o">*</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span> <span class="o">=</span> <span class="p">(</span><span class="n">UserData</span><span class="o">*</span><span class="p">)</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">userData</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">AInputEvent_getType</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">AINPUT_EVENT_TYPE_KEY</span>:
        <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">AKeyEvent_getAction</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="n">AKEY_EVENT_ACTION_DOWN</span>:
                <span class="p">{</span>
                    <span class="n">KeyDown</span><span class="p">(</span><span class="n">userData</span><span class="p">,</span> <span class="n">AKeyEvent_getKeyCode</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="n">AKEY_EVENT_ACTION_UP</span>:
                <span class="p">{</span>
                    <span class="n">KeyUp</span><span class="p">(</span><span class="n">userData</span><span class="p">,</span> <span class="n">AKeyEvent_getKeyCode</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">AINPUT_EVENT_TYPE_MOTION</span>:
        <span class="p">{</span>
            <span class="kt">size_t</span> <span class="n">numPointers</span> <span class="o">=</span> <span class="n">AMotionEvent_getPointerCount</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">numPointers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int32_t</span> <span class="n">action</span> <span class="o">=</span> <span class="n">AMotionEvent_getAction</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

                <span class="k">switch</span> <span class="p">(</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">AMOTION_EVENT_ACTION_MASK</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">case</span> <span class="n">AMOTION_EVENT_ACTION_DOWN</span>:
                    <span class="k">case</span> <span class="n">AMOTION_EVENT_ACTION_POINTER_DOWN</span>:
                    <span class="p">{</span>
                        <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">AMotionEvent_getX</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                        <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">AMotionEvent_getY</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">app</span><span class="o">-&gt;</span><span class="n">contentRect</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
                        <span class="n">MouseDown</span><span class="p">(</span><span class="n">userData</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">case</span> <span class="n">AMOTION_EVENT_ACTION_UP</span>:
                    <span class="k">case</span> <span class="n">AMOTION_EVENT_ACTION_POINTER_UP</span>:
                    <span class="p">{</span>
                        <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">AMotionEvent_getX</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                        <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">AMotionEvent_getY</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">app</span><span class="o">-&gt;</span><span class="n">contentRect</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
                        <span class="n">MouseUp</span><span class="p">(</span><span class="n">userData</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">case</span> <span class="n">AMOTION_EVENT_ACTION_MOVE</span>:
                    <span class="p">{</span>
                        <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">AMotionEvent_getX</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                        <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">AMotionEvent_getY</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">app</span><span class="o">-&gt;</span><span class="n">contentRect</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
                        <span class="n">MouseMove</span><span class="p">(</span><span class="n">userData</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">HandleAppCmd</span><span class="p">(</span><span class="n">android_app</span><span class="o">*</span> <span class="n">app</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">UserData</span><span class="o">*</span> <span class="n">userData</span> <span class="o">=</span> <span class="p">(</span><span class="n">UserData</span><span class="o">*</span><span class="p">)</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">userData</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">APP_CMD_INIT_WINDOW</span>:
        <span class="p">{</span>
            <span class="c1">// The window is being shown, get it ready</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">userData</span><span class="o">-&gt;</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">InitDisplay</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">APP_CMD_CONTENT_RECT_CHANGED</span>:
        <span class="k">case</span> <span class="n">APP_CMD_WINDOW_RESIZED</span>:
        <span class="p">{</span>
            <span class="n">ResizeDisplay</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">APP_CMD_WINDOW_REDRAW_NEEDED</span>:
        <span class="p">{</span>
            <span class="n">DrawFrame</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">APP_CMD_TERM_WINDOW</span>:
        <span class="p">{</span>
            <span class="c1">// The window is being hidden or closed, clean it up</span>
            <span class="n">ShutdownDisplay</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">APP_CMD_LOST_FOCUS</span>:
        <span class="p">{</span>
            <span class="c1">// Stop animating</span>
            <span class="n">userData</span><span class="o">-&gt;</span><span class="n">animating</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">DrawFrame</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">APP_CMD_GAINED_FOCUS</span>:
        <span class="p">{</span>
            <span class="c1">// Restart animating</span>
            <span class="n">userData</span><span class="o">-&gt;</span><span class="n">animating</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">DrawFrame</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">APP_CMD_CONFIG_CHANGED</span>:
        <span class="p">{</span>
            <span class="n">ResizeDisplay</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">android_main</span><span class="p">(</span><span class="n">android_app</span><span class="o">*</span> <span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">LOGI</span><span class="p">(</span><span class="s">&quot;android_main BEGIN&quot;</span><span class="p">);</span>

    <span class="c1">// Ensure app wrapper code is not discarded</span>
    <span class="n">app_dummy</span><span class="p">();</span>

    <span class="n">UserData</span> <span class="n">userData</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">userData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UserData</span><span class="p">));</span>
    <span class="n">app</span><span class="o">-&gt;</span><span class="n">userData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">userData</span><span class="p">;</span>
    <span class="n">app</span><span class="o">-&gt;</span><span class="n">onAppCmd</span> <span class="o">=</span> <span class="n">HandleAppCmd</span><span class="p">;</span>
    <span class="n">app</span><span class="o">-&gt;</span><span class="n">onInputEvent</span> <span class="o">=</span> <span class="n">HandleInput</span><span class="p">;</span>
    <span class="n">userData</span><span class="p">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="p">;</span>

    <span class="kt">bool</span> <span class="n">loop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">loop</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Read all pending events</span>
        <span class="kt">int</span> <span class="n">events</span><span class="p">;</span>
        <span class="n">android_poll_source</span><span class="o">*</span> <span class="n">source</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">ALooper_pollAll</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">events</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">source</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Process this event</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">source</span><span class="o">-&gt;</span><span class="n">process</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// Check if exiting occurs before window was created</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">destroyRequested</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">LOGI</span><span class="p">(</span><span class="s">&quot;App destroyed&quot;</span><span class="p">);</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">&amp;&amp;</span> <span class="n">userData</span><span class="p">.</span><span class="n">animating</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">DrawFrame</span><span class="p">(</span><span class="o">&amp;</span><span class="n">userData</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">LOGI</span><span class="p">(</span><span class="s">&quot;android_main END&quot;</span><span class="p">);</span>

    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<br/>
<div>
    <div class="headerbg">
        <div class="footertext" style="height:32px; background:#262626;">
            &nbsp;<br/>2013 (C) Noesis Technologies
        </div>
    </div>
</div>
</div>
</body>
</html>
